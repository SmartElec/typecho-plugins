/*!
 * HyperMD, copyright (c) by laobubu
 * Distributed under an MIT license: http://laobubu.net/HyperMD/LICENSE
 *
 * Break the Wall between writing and preview, in a Markdown Editor.
 *
 * HyperMD makes Markdown editor on web WYSIWYG, based on CodeMirror
 *
 * Homepage: http://laobubu.net/HyperMD/
 * Issues: https://github.com/laobubu/HyperMD/issues
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("codemirror"),require("codemirror/addon/fold/foldcode"),require("codemirror/addon/fold/foldgutter"),require("codemirror/addon/fold/markdown-fold"),require("codemirror/addon/edit/closebrackets"),require("codemirror/lib/codemirror.css"),require("codemirror/addon/fold/foldgutter.css"),require("./theme/hypermd-light.css"),require("codemirror/mode/markdown/markdown"),require("./mode/hypermd.css"),require("codemirror/mode/meta")):"function"==typeof define&&define.amd?define(["exports","codemirror","codemirror/addon/fold/foldcode","codemirror/addon/fold/foldgutter","codemirror/addon/fold/markdown-fold","codemirror/addon/edit/closebrackets","codemirror/lib/codemirror.css","codemirror/addon/fold/foldgutter.css","./theme/hypermd-light.css","codemirror/mode/markdown/markdown","./mode/hypermd.css","codemirror/mode/meta"],t):t(e.HyperMD={},e.CodeMirror)}(this,function(e,q){"use strict";"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(e,t){var n=arguments;if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var r=Object(e),i=1;i<arguments.length;i++){var o=n[i];if(null!=o)for(var a in o)Object.prototype.hasOwnProperty.call(o,a)&&(r[a]=o[a])}return r},writable:!0,configurable:!0});var s=function(e,t,n,r){void 0===n&&(n=!1),void 0===r&&(r="enabled"),this.on_cb=e,this.off_cb=t,this.state=n,this.subkey=r};function c(t,n,r){n=~~n||5;var i=250;setTimeout(function e(){if(n--){try{if(t())return}catch(e){}setTimeout(e,i),i*=2}else r&&r()},0)}function h(e,t){var n=null,r=0,i=function(){e(),n=0},o=function(){var e=+new Date;if(n){if(e<r)return;clearTimeout(n)}n=setTimeout(i,t),r=e+100};return o.stop=function(){n&&(clearTimeout(n),n=0)},o}s.prototype.ON=function(e){return this.on_cb=e,this},s.prototype.OFF=function(e){return this.off_cb=e,this},s.prototype.set=function(e,t){var n="object"==typeof e&&e?e[this.subkey]:e;t&&(n=!!n),n!==this.state&&((this.state=n)?this.on_cb&&this.on_cb(n):this.off_cb&&this.off_cb(n))},s.prototype.setBool=function(e){return this.set(e,!0)},s.prototype.bind=function(e,t,n){var r=this;return Object.defineProperty(e,t,{get:function(){return r.state},set:function(e){return r.set(e,n)},configurable:!0,enumerable:!0}),this};var r=q.addClass,i=q.rmClass,t=q.contains;function a(e,t){var n=new Array(t);if(n.fill)n.fill(e);else for(var r=0;r<t;r++)n[r]=e;return n}function z(e,t){for(var n="";0<t--;)n+=e;return n}function m(e,t){for(var n,r=[e];n=r.shift();)for(var i=0;i<n.length;i++){var o=n[i];o&&o.nodeType==Node.ELEMENT_NODE&&(t(o),o.children&&0<o.children.length&&r.push(o.children))}}function p(r,i,o){var e=r.getBoundingClientRect(),a=e.width,l=e.height,s=h(function(){var e=r.getBoundingClientRect(),t=e.width,n=e.height;a==t&&l==n||(i(t,n,a,l),a=t,l=n,setTimeout(s,200))},100),t=null;var n=!1;var d=[];return o||m([r],function(e){var t,n=e.tagName,r=getComputedStyle(e);"none"!=(t="resize",r.getPropertyValue(t)||"")&&(o=!0),/^(?:img|video)$/i.test(n)?(e.addEventListener("load",s,!1),e.addEventListener("error",s,!1)):/^(?:details|summary)$/i.test(n)&&e.addEventListener("click",s,!1)}),o&&(t=setTimeout(function e(){t&&clearTimeout(t),n||(t=setTimeout(e,200)),s()},200)),{check:s,stop:function(){n=!0,s.stop(),t&&(clearTimeout(t),t=null);for(var e=0;e<d.length;e++)d[e][0].removeEventListener(d[e][1],s,!1)}}}var o={lineNumbers:!0,lineWrapping:!0,theme:"hypermd-light",mode:"text/x-hypermd",tabSize:4,autoCloseBrackets:!0,foldGutter:!0,gutters:["CodeMirror-linenumbers","CodeMirror-foldgutter","HyperMD-goback"]};function l(e,t){if(t>=e.display.viewTo)return null;if((t-=e.display.viewFrom)<0)return null;for(var n=e.display.view,r=0;r<n.length;r++)if((t-=n[r].size)<0)return r}function L(e,t){if(t>=e.display.viewFrom&&t<e.display.viewTo)return e.display.view[l(e,t)];var n=e.display.externalMeasured;return n&&t>=n.lineN&&t<n.lineN+n.size?n:void 0}function w(e,t,n){if(e.line==t)return{map:e.measure.map,cache:e.measure.cache,before:!1};for(var r=0;r<e.rest.length;r++)if(e.rest[r]==t)return{map:e.measure.maps[r],cache:e.measure.caches[r],before:!1};for(var i=0;i<e.rest.length;i++)if(e.rest[i].lineNo()>n)return{map:e.measure.maps[i],cache:e.measure.caches[i],before:!0}}var n=Object.freeze({findViewIndex:l,findViewForLine:L,mapFromLineView:w}),U=function(e){this.cm=e};function x(e,t,n){var r,i=t.line,o={line:i,ch:0},a={line:i,ch:t.ch},l="function"==typeof n&&n,s=!l&&new RegExp("(?:^|\\s)"+n+"(?:\\s|$)"),d=e.getLineTokens(i);for(r=0;r<d.length&&!(d[r].end>=t.ch);r++);if(r===d.length)return null;for(var c=r;c<d.length;c++){var h=d[c];if(l?!l(h):!s.test(h.type))break;a.ch=h.end}for(c=r;0<=c;c--){h=d[c];if(!(l?l(h):s.test(h.type))){o.ch=h.end;break}}return{from:o,to:a}}function d(e,t){if(!t)for(var n=0,r=e.display.view;n<r.length;n+=1){var i=r[n];i.measure&&(i.measure.cache={})}setTimeout(function(){e.display.input.showSelection(e.display.input.prepareSelection())},60)}U.prototype.findNext=function(n,e,r){var i=this.lineNo,o=this.lineTokens,a=null,l=this.i_token+1,t=!1;if(!0===e?t=!0:"number"==typeof e&&(l=e),r)if(r.line>i)l=o.length;else if(r.line<i);else for(;l<o.length&&!(o[l].start>=r.ch);l++);for(;l<o.length;l++){var s=o[l];if("function"==typeof n?n(s):n.test(s.type)){a=s;break}}if(!a&&t){var d=this.cm,c=Math.max(r?r.line:0,i+1);d.eachLine(c,d.lastLine()+1,function(e){if(i=e.lineNo(),o=d.getLineTokens(i),l=0,r&&i===r.line)for(;l<o.length&&!(o[l].start>=r.ch);l++);for(;l<o.length;l++){var t=o[l];if("function"==typeof n?n(t):n.test(t.type))return a=t,!0}})}return a?{lineNo:i,token:a,i_token:l}:null},U.prototype.findPrev=function(e,t,n){var r=this.lineNo,i=this.lineTokens,o=null,a=this.i_token-1,l=!1;if(!0===t?l=!0:"number"==typeof t&&(a=t),n)if(n.line<r)a=-1;else if(n.line>r);else for(;a<i.length&&!(i[a].start>=n.ch);a++);for(a>=i.length&&(a=i.length-1);0<=a;a--){var s=i[a];if("function"==typeof e?e(s):e.test(s.type)){o=s;break}}if(!o&&l){var d=this.cm,c=Math.min(n?n.line:d.lastLine(),r-1),h=d.firstLine();for(r=c+1;!o&&h<=--r;){d.getLineHandle(r);if(i=d.getLineTokens(r),a=0,n&&r===n.line)for(;a<i.length&&!(i[a].start>=n.ch);a++);for(a>=i.length&&(a=i.length-1);0<=a;a--){s=i[a];if("function"==typeof e?e(s):e.test(s.type)){o=s;break}}}}return o?{lineNo:r,token:o,i_token:a}:null},U.prototype.expandRange=function(t,e){var n,r=this.cm;"function"==typeof t?n=t:("string"==typeof t&&(t=new RegExp("(?:^|\\s)"+t+"(?:\\s|$)")),n=function(e){return!!e&&t.test(e.type||"")});for(var i={lineNo:this.lineNo,i_token:this.i_token,token:this.lineTokens[this.i_token]},o=Object.assign({},i),a=!1,l=this.lineTokens,s=this.i_token;!a;){for(s>=l.length&&(s=l.length-1);0<=s;s--){var d=l[s];if(!n(d)){a=!0;break}i.i_token=s,i.token=d}if(a||!(e&&i.lineNo>r.firstLine()))break;s=(l=r.getLineTokens(--i.lineNo)).length-1}for(a=!1,l=this.lineTokens,s=this.i_token;!a;){for(s<0&&(s=0);s<l.length;s++){var c=l[s];if(!n(c)){a=!0;break}o.i_token=s,o.token=c}if(a||!(e&&o.lineNo<r.lastLine()))break;l=r.getLineTokens(++o.lineNo),s=0}return{from:i,to:o}},U.prototype.setPos=function(e,t,n){void 0===t?(t=e,e=this.line):"number"==typeof e&&(e=this.cm.getLineHandle(e));var r=e===this.line,i=0;n||!r?(this.line=e,this.lineNo=e.lineNo(),this.lineTokens=this.cm.getLineTokens(this.lineNo)):(i=this.i_token,this.lineTokens[i].start>t&&(i=0));for(var o=this.lineTokens;i<o.length&&!(o[i].end>t);i++);this.i_token=i},U.prototype.getToken=function(e){return"number"!=typeof e&&(e=this.i_token),this.lineTokens[e]},U.prototype.getTokenType=function(e){"number"!=typeof e&&(e=this.i_token);var t=this.lineTokens[e];return t&&t.type||""};function u(r,i,o){return function(e){if(e.hmd||(e.hmd={}),!e.hmd[r]){var t=new i(e);if(e.hmd[r]=t,o)for(var n in o)t[n]=o[n];return t}return e.hmd[r]}}var f=Object.freeze({Addon:function(e){},Getter:u}),P=/[^\\][$|]/,j=/^(?:[*\-+]|^[0-9]+([.)]))\s+/,$=/^((?:(?:aaas?|about|acap|adiumxtra|af[ps]|aim|apt|attachment|aw|beshare|bitcoin|bolo|callto|cap|chrome(?:-extension)?|cid|coap|com-eventbrite-attendee|content|crid|cvs|data|dav|dict|dlna-(?:playcontainer|playsingle)|dns|doi|dtn|dvb|ed2k|facetime|feed|file|finger|fish|ftp|geo|gg|git|gizmoproject|go|gopher|gtalk|h323|hcp|https?|iax|icap|icon|im|imap|info|ipn|ipp|irc[6s]?|iris(?:\.beep|\.lwz|\.xpc|\.xpcs)?|itms|jar|javascript|jms|keyparc|lastfm|ldaps?|magnet|mailto|maps|market|message|mid|mms|ms-help|msnim|msrps?|mtqp|mumble|mupdate|mvn|news|nfs|nih?|nntp|notes|oid|opaquelocktoken|palm|paparazzi|platform|pop|pres|proxy|psyc|query|res(?:ource)?|rmi|rsync|rtmp|rtsp|secondlife|service|session|sftp|sgn|shttp|sieve|sips?|skype|sm[bs]|snmp|soap\.beeps?|soldat|spotify|ssh|steam|svn|tag|teamspeak|tel(?:net)?|tftp|things|thismessage|tip|tn3270|tv|udp|unreal|urn|ut2004|vemmi|ventrilo|view-source|webcal|wss?|wtai|wyciwyg|xcon(?:-userid)?|xfire|xmlrpc\.beeps?|xmpp|xri|ymsgr|z39\.50[rs]?):(?:\/{1,3}|[a-z0-9%])|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,4}\/)(?:[^\s()<>]|\([^\s()<>]*\))+(?:\([^\s()<>]*\)|[^\s`*!()\[\]{};:'".,<>?«»“”‘’]))/i,K=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,B=/^\.{0,2}\/[^\>\s]+/,X=/^\s*[^\|].*?\|.*[^|]\s*$/,W=/^\s*[^\|].*\|/,Y=/^\s*\|[^\|]+\|.+\|\s*$/,G=/^\s*\|/,V={};function Z(e){e.hmdTable=0,e.hmdTableColumns=[],e.hmdTableID=null,e.hmdTableCol=e.hmdTableRow=0}V[1]="hmd-barelink",V[6]="hmd-barelink2",V[2]="hmd-barelink hmd-footref",V[4]="hmd-footnote line-HyperMD-footnote",V[7]="hmd-footref2";var Q=/^\s+((\d+[).]|[-*+])\s+)?/;q.defineMode("hypermd",function(o,e){var N={front_matter:"yaml",math:!0,table:!0,toc:!0,orgModeMarkup:!0,fencedCodeBlockHighlighting:!0,name:"markdown",highlightFormatting:!0,taskLists:!0,strikethrough:!0,emoji:!0,tokenTypeOverrides:{hr:"line-HyperMD-hr hr",list1:"list-1",list2:"list-2",list3:"list-3",code:"inline-code",gitHubSpice:!1}};Object.assign(N,e),N.name="markdown";var R={htmlBlock:null},E=q.getMode(o,N),t=Object.assign({},E);function a(e,t){var n=t.hmdInnerExitChecker(e,t),r=t.hmdInnerStyle,i=(!n||!n.skipInnerMode)&&t.hmdInnerMode.token(e,t.hmdInnerState)||"";return r&&(i+=" "+r),n&&(n.style&&(i+=" "+n.style),n.endPos&&(e.pos=n.endPos),t.hmdInnerExitChecker=null,t.hmdInnerMode=null,t.hmdInnerState=null,t.hmdOverride=null),i.trim()||null}function _(n){return{token:function(e){var t=e.string.indexOf(n,e.start);return-1===t?e.skipToEnd():0===t?e.pos+=n.length:(e.pos=t,"\\"===e.string.charAt(t-1)&&e.pos++),null}}}function I(n,r){return r||(r={}),function(e,t){return e.string.substr(e.start,n.length)===n?(r.endPos=e.start+n.length,r):null}}function F(e,t,n,r){if("string"==typeof n&&(n=q.getMode(o,n)),!(n&&"null"!==n.name||(n="endTag"in r?_(r.endTag):r.fallbackMode)))throw new Error("no mode");t.hmdInnerExitChecker="endTag"in r?I(r.endTag):r.exitChecker,t.hmdInnerStyle=r.style,t.hmdInnerMode=n,t.hmdOverride=a,t.hmdInnerState=q.startState(n);var i=r.style||"";return r.skipFirstToken||(i+=" "+n.token(e,t.hmdInnerState)),i.trim()}return t.startState=function(){var e=E.startState();return Z(e),e.hmdOverride=null,e.hmdInnerExitChecker=null,e.hmdInnerMode=null,e.hmdLinkType=0,e.hmdNextMaybe=N.front_matter?1:0,e.hmdNextState=null,e.hmdNextStyle=null,e.hmdNextPos=null,e},t.copyState=function(e){for(var t=E.copyState(e),n=0,r=["hmdLinkType","hmdNextMaybe","hmdTable","hmdTableID","hmdTableCol","hmdTableRow","hmdOverride","hmdInnerMode","hmdInnerStyle","hmdInnerExitChecker","hmdNextPos","hmdNextState","hmdNextStyle"];n<r.length;n+=1){var i=r[n];t[i]=e[i]}return t.hmdTableColumns=e.hmdTableColumns.slice(0),e.hmdInnerMode&&(t.hmdInnerState=q.copyState(e.hmdInnerMode,e.hmdInnerState)),t},t.blankLine=function(e){var t,n=e.hmdInnerMode;return n?n.blankLine&&(t=n.blankLine(e.hmdInnerState)):t=E.blankLine(e),t||(t=""),-1===e.code&&(t+=" line-HyperMD-codeblock line-background-HyperMD-codeblock-bg"),Z(e),t.trim()||null},t.indent=function(e,t){var n=e.hmdInnerMode||E,r=n.indent;return"function"==typeof r?r.apply(n,arguments):q.Pass},t.innerMode=function(e){return e.hmdInnerMode?{mode:e.hmdInnerMode,state:e.hmdInnerState}:E.innerMode(e)},t.token=function(e,t){if(t.hmdOverride)return t.hmdOverride(e,t);if(1===t.hmdNextMaybe&&(t.hmdNextMaybe=2,"---"===e.string))return F(e,t,"yaml",{style:"hmd-frontmatter",fallbackMode:_("---"),exitChecker:function(e,t){return"---"===e.string?(t.hmdNextMaybe=0,{endPos:3}):null}});var n,r=t.f===R.htmlBlock,i=-1===t.code,o=0===e.start,a=t.linkText,l=t.linkHref,s=!(i||r),d=s&&!(t.code||t.indentedCode||t.linkHref),c="";if(s){if(N.math&&d&&(n=e.match(/^\${1,2}/,!1))){var h=n[0],u=h.length;if(2===u||e.string.slice(e.pos).match(/[^\\]\$/))return c+=F(e,t,"stex",{style:"math",fallbackMode:_(h),exitChecker:I(h,{style:"formatting formatting-math formatting-math-end math-"+u})}),c+=" formatting formatting-math formatting-math-begin math-"+u}if(o&&N.orgModeMarkup&&(n=e.match(/^\#\+(\w+\:?)\s*/)))return e.eol()||(t.hmdOverride=function(e,t){return e.skipToEnd(),t.hmdOverride=null,"string hmd-orgmode-markup"}),"meta formatting-hmd-orgmode-markup hmd-orgmode-markup line-HyperMD-orgmode-markup";if(o&&N.toc&&e.match(/^\[TOC\]\s*$/i))return"meta line-HyperMD-toc hmd-toc";if(d&&!t.hmdLinkType&&(e.match($)||e.match(K)))return"url"}t.hmdNextState?(e.pos=t.hmdNextPos,c+=" "+(t.hmdNextStyle||""),Object.assign(t,t.hmdNextState),t.hmdNextState=null,t.hmdNextStyle=null,t.hmdNextPos=null):c+=" "+(E.token(e,t)||""),!R.htmlBlock&&t.htmlState&&(R.htmlBlock=t.f);var f=t.f===R.htmlBlock,m=-1===t.code;s=s&&!(f||m),(d=d&&s&&!(t.code||t.indentedCode||t.linkHref))&&(n=e.current().match(P))&&(e.pos=e.start+n.index+1);var p=e.current();if(f!=r&&(f?(c+=" hmd-html-begin",R.htmlBlock=t.f):c+=" hmd-html-end"),(i||m)&&(t.localMode&&i||(c=c.replace("inline-code","")),c+=" line-HyperMD-codeblock line-background-HyperMD-codeblock-bg",m!==i&&(m?i||(c+=" line-HyperMD-codeblock-begin"):c+=" line-HyperMD-codeblock-end")),s){var g=t.hmdTable;if(o&&g)(1==g?W:G).test(e.string)?(t.hmdTableCol=0,t.hmdTableRow++):Z(t);if(t.header&&(t.prevLine&&t.prevLine.header?c+=" line-HyperMD-header-line line-HyperMD-header-line-"+t.header:c+=" line-HyperMD-header line-HyperMD-header-"+t.header),t.indentedCode&&(c+=" hmd-indented-code"),t.quote){if(e.eol()&&(c+=" line-HyperMD-quote line-HyperMD-quote-"+t.quote,/^ {0,3}\>/.test(e.string)||(c+=" line-HyperMD-quote-lazy")),0==e.start&&(n=p.match(/^\s+/)))return e.pos=n[0].length,(c+=" hmd-indent-in-quote").trim();/^>\s+$/.test(p)&&">"!=e.peek()&&(e.pos=e.start+1,p=">",t.hmdOverride=function(e,t){return e.match(Q),t.hmdOverride=null,"hmd-indent-in-quote line-HyperMD-quote line-HyperMD-quote-"+t.quote})}var v=(t.listStack[t.listStack.length-1]||0)+3,y=o&&/^\s+$/.test(p)&&(!1!==t.list||e.indentation()<=v),b=t.list&&/formatting-list/.test(c);if(b||y&&(!1!==t.list||e.match(j,!1))){var k=t.listStack&&t.listStack.length||0;if(y){if(e.match(j,!1))!1===t.list&&k++;else{for(;0<k&&e.pos<t.listStack[k-1];)k--;if(!k)return c.trim()||null;c+=" line-HyperMD-list-line-nobullet line-HyperMD-list-line line-HyperMD-list-line-"+k}c+=" hmd-list-indent hmd-list-indent-"+k}else b&&(c+=" line-HyperMD-list-line line-HyperMD-list-line-"+k)}if(a!==t.linkText&&(a?(t.hmdLinkType in V&&(c+=" "+V[t.hmdLinkType]),4===t.hmdLinkType?t.hmdLinkType=5:t.hmdLinkType=0):(n=e.match(/^([^\]]+)\](\(| ?\[|\:)?/,!1)||["](","","("])[2]?":"===n[2]?t.hmdLinkType=4:"["!==n[2]&&" ["!==n[2]||"]"!==e.string.charAt(e.pos+n[0].length)?t.hmdLinkType=3:t.hmdLinkType=6:"^"===n[1].charAt(0)?t.hmdLinkType=2:t.hmdLinkType=1),l!==t.linkHref&&(l?t.hmdLinkType&&(c+=" "+V[t.hmdLinkType],t.hmdLinkType=0):"["===p&&"]"!==e.peek()&&(t.hmdLinkType=7)),0!==t.hmdLinkType&&(t.hmdLinkType in V&&(c+=" "+V[t.hmdLinkType]),5===t.hmdLinkType&&(/^(?:\]\:)?\s*$/.test(p)||($.test(p)||B.test(p)?c+=" hmd-footnote-url":c=c.replace("string url",""),t.hmdLinkType=0))),/formatting-escape/.test(c)&&1<p.length){var T=p.length-1,L=c.replace("formatting-escape","escape")+" hmd-escape-char";return t.hmdOverride=function(e,t){return e.pos+=T,t.hmdOverride=null,L.trim()},c+=" hmd-escape-backslash",e.pos-=T,c}if(!c.trim()&&N.table){var w=!1;if("|"===p.charAt(0)&&(e.pos=e.start+1,p="|",w=!0),w){if(!g){var x;if(X.test(e.string)?g=1:Y.test(e.string)&&(g=2),g){var M=e.lookAhead(1);if(2===g?Y.test(M)?M=M.replace(/^\s*\|/,"").replace(/\|\s*$/,""):g=0:1===g&&(X.test(M)||(g=0)),g){x=M.split("|");for(var S=0;S<x.length;S++){var C=x[S];if(/^\s*--+\s*:\s*$/.test(C))C="right";else if(/^\s*:\s*--+\s*$/.test(C))C="left";else if(/^\s*:\s*--+\s*:\s*$/.test(C))C="center";else{if(!/^\s*--+\s*$/.test(C)){g=0;break}C="default"}x[S]=C}}}g&&(t.hmdTable=g,t.hmdTableColumns=x,t.hmdTableID="T"+e.lineOracle.line,t.hmdTableRow=t.hmdTableCol=0)}if(g){var O=t.hmdTableColumns.length-1;if(2===g&&(0===t.hmdTableCol&&/^\s*\|$/.test(e.string.slice(0,e.pos))||e.match(/^\s*$/,!1)))c+=" hmd-table-sep hmd-table-sep-dummy";else if(t.hmdTableCol<O){var H=t.hmdTableRow,A=t.hmdTableCol++;0==A&&(c+=" line-HyperMD-table_"+t.hmdTableID+" line-HyperMD-table-"+g+" line-HyperMD-table-row line-HyperMD-table-row-"+H),c+=" hmd-table-sep hmd-table-sep-"+A}}}}if(g&&1===t.hmdTableRow&&/emoji/.test(c)&&(c=""),d&&"<"===p){var D=null;if(e.match(/^\![A-Z]+/)?D=">":e.match("?")?D="?>":e.match("![CDATA[")&&(D="]]>"),null!=D)return F(e,t,null,{endTag:D,style:(c+" comment hmd-cdata-html").trim()})}}return c.trim()||null},t},"hypermd"),q.defineMIME("text/x-hypermd","hypermd");var g=Object.freeze({});function v(e,t,n,r){var i=new XMLHttpRequest,o=new FormData;for(var a in t)o.append(a,t[a]);i.onreadystatechange=function(){if(4==this.readyState){var e=i.responseText;try{e=JSON.parse(i.responseText)}catch(e){}/^20\d/.test(i.status+"")?n(e,null):n(null,e)}},i.open(r||"POST",e,!0),i.send(o)}var y=function(e,i){var o=0,t=document.createElement("div");t.className="HyperMD-insertFile-dfh-placeholder",i.setPlaceholder(t);for(var a=[],l="undefined"!=typeof URL,n=0;n<e.length;n++){var r=e[n];if(/image\//.test(r.type)){var s=l?URL.createObjectURL(r):"",d=r.name.match(/[^\\\/]+\.\w+$/)[0],c=document.createElement("img");c.onload=i.resize,c.className="HyperMD-insertFile-dfh-uploading",c.src=s,t.appendChild(c),a.push({blobURL:s,name:d,url:null,placeholder:c}),o++,h(r,a.length-1)}}return 0<o;function h(e,r){v("https://sm.ms/api/upload",{smfile:e,format:"json"},function(e,t){var n=e&&"success"==e.code?e.data.url:null;!function(e,t){a[e].url=t;var n=a[e].placeholder;if(n.className="HyperMD-insertFile-dfh-uploaded",n.src=t||"",l&&URL.revokeObjectURL(a[e].blobURL),0==--o){var r=a.map(function(e){return"!["+e.name+"]("+e.url+")"});i.finish(r.join(" ")+" ")}}(r,n)})}},b={byDrop:!1,byPaste:!1,fileHandler:y},k={byPaste:!0,byDrop:!0};o.hmdInsertFile=k,q.defineOption("hmdInsertFile",b,function(e,t){if(t&&"boolean"!=typeof t)"function"==typeof t&&(t={byDrop:!0,byPaste:!0,fileHandler:t});else{var n=!!t;t={byDrop:n,byPaste:n}}var r=M(e);for(var i in b)r[i]=i in t?t[i]:b[i]});var T=function(e){var o=this;this.cm=e,this.pasteHandle=function(e,t){o.doInsert(t.clipboardData||window.clipboardData)&&t.preventDefault()},this.dropHandle=function(t,n){var r=o,i=(t=o.cm,!1);t.operation(function(){var e=t.coordsChar({left:n.clientX,top:n.clientY},"window");t.setCursor(e),i=r.doInsert(n.dataTransfer)}),i&&n.preventDefault()},new s(function(){return o.cm.on("paste",o.pasteHandle)},function(){return o.cm.off("paste",o.pasteHandle)}).bind(this,"byPaste",!0),new s(function(){return o.cm.on("drop",o.dropHandle)},function(){return o.cm.off("drop",o.dropHandle)}).bind(this,"byDrop",!0)};T.prototype.doInsert=function(e){var a=this.cm;if(!e||!e.files||0===e.files.length)return!1;var r=e.files,i=this.fileHandler||y,l=!1;return a.operation(function(){a.replaceSelection(".");var e=a.getCursor(),t={line:e.line,ch:e.ch-1},n=document.createElement("span"),o=a.markText(t,e,{replacedWith:n,clearOnEnter:!1,handleMouseEvents:!1});(l=i(r,{marker:o,cm:a,finish:function(r,i){return a.operation(function(){var e=o.find(),t=e.from,n=e.to;a.replaceRange(r,t,n),o.clear(),"number"==typeof i&&a.setCursor({line:t.line,ch:t.ch+i})})},setPlaceholder:function(e){0<n.childNodes.length&&n.removeChild(n.firstChild),n.appendChild(e),o.changed()},resize:function(){o.changed()}}))||o.clear()}),l};var M=u("InsertFile",T,b),S=Object.freeze({ajaxUpload:v,DefaultFileHandler:y,defaultOption:b,suggestedOption:k,InsertFile:T,getAddon:M});function C(e){var t=e=e.trim(),n="",r=e.match(/^(\S+)\s+("(?:[^"\\]+|\\.)+"|[^"\s].*)/);return r&&(t=r[1],'"'===(n=r[2]).charAt(0)&&(n=n.substr(1,n.length-2).replace(/\\"/g,'"'))),{url:t,title:n}}var O={hmdReadLink:function(e,t){return R(this).read(e,t)},hmdResolveURL:function(e,t){return R(this).resolve(e,t)},hmdSplitLink:C};for(var H in O)q.defineExtension(H,O[H]);var A={baseURI:""},D={baseURI:""};o.hmdReadLink=D,q.defineOption("hmdReadLink",A,function(e,t){t&&"string"!=typeof t||(t={baseURI:t});var n=R(e);for(var r in A)n[r]=r in t?t[r]:A[r]});var N=function(e){var t=this;this.cm=e,this.cache={},e.on("changes",h(function(){return t.rescan()},500)),this.rescan()};N.prototype.read=function(e,t){var n,r=this.cache[e.trim().toLowerCase()]||[];"number"!=typeof t&&(t=1e9);for(var i=0;i<r.length&&!((n=r[i]).line>t);i++);return n},N.prototype.rescan=function(){var e=this.cm,o=this.cache={};e.eachLine(function(e){var t=e.text,n=/^(?:>\s+)*>?\s{0,3}\[([^\]]+)\]:\s*(.+)$/.exec(t);if(n){var r=n[1].trim().toLowerCase(),i=n[2];o[r]||(o[r]=[]),o[r].push({line:e.lineNo(),content:i})}})},N.prototype.resolve=function(e,t){var n,r=/^(?:[\w-]+\:\/*|\/\/)[^\/]+/,i=/\/[^\/]+(?:\/+\.?)*$/;if(!e)return e;if(/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(e))return"mailto:"+e;var o="";if(!(t=t||this.baseURI)||r.test(e))return e;for((n=t.match(r))&&(o=n[0],t=t.slice(o.length));n=e.match(/^(\.{1,2})([\/\\]+)/);)e=e.slice(n[0].length),".."==n[1]&&(t=t.replace(i,""));return"/"===e.charAt(0)&&o?e=o+e:(/\/$/.test(t)||(t+="/"),e=o+t+e),e};var R=u("ReadLink",N,A),E=Object.freeze({splitLink:C,Extensions:O,defaultOption:A,suggestedOption:D,ReadLink:N,getAddon:R}),_="function"==typeof marked?marked:function(e){return"<pre>"+(e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/  /g," &nbsp;"))+"</pre>"};function I(e,t){return t?_(t):null}var F={enabled:!1,xOffset:10,convertor:I},J={enabled:!0};o.hmdHover=J,q.defineOption("hmdHover",F,function(e,t){t&&"boolean"!=typeof t?"function"==typeof t&&(t={enabled:!0,convertor:t}):t={enabled:!!t};var n=ne(e);for(var r in F)n[r]=r in t?t[r]:F[r]});var ee=function(e){var t=this;this.cm=e,new s(function(){n.addEventListener("mouseenter",a,!0)},function(){n.removeEventListener("mouseenter",a,!0),t.hideInfo()}).bind(this,"enabled",!0);var n=e.display.lineDiv;this.lineDiv=n;var r=document.createElement("div"),i=document.createElement("div"),o=document.createElement("div");r.setAttribute("style","position:absolute;z-index:99"),r.setAttribute("class","HyperMD-hover"),r.setAttribute("cm-ignore-events","true"),i.setAttribute("class","HyperMD-hover-content"),r.appendChild(i),o.setAttribute("class","HyperMD-hover-indicator"),r.appendChild(o),this.tooltipDiv=r,this.tooltipContentDiv=i,this.tooltipIndicator=o;var a=this.mouseenter.bind(this)};ee.prototype.mouseenter=function(e){var t,n=this.cm,r=e.target,i=r.className;if(!(r==this.tooltipDiv||r.compareDocumentPosition&&8==(8&r.compareDocumentPosition(this.tooltipDiv))))if("SPAN"===r.nodeName&&(t=i.match(/(?:^|\s)cm-(hmd-barelink2?|hmd-footref2)(?:\s|$)/))){var o=n.coordsChar({left:e.clientX,top:e.clientY},"window"),a=null,l=null,s=x(n,o,t[1]);s&&(a=(a=n.getRange(s.from,s.to)).slice(1,-1))&&(l=n.hmdReadLink(a,o.line)||null);var d=(this.convertor||I)(a,l&&l.content||null);d?this.showInfo(d,r):this.hideInfo()}else this.hideInfo()},ee.prototype.showInfo=function(e,t){var n=t.getBoundingClientRect(),r=this.lineDiv.getBoundingClientRect(),i=this.tooltipDiv,o=this.xOffset;this.tooltipContentDiv.innerHTML=e,i.style.left=n.left-r.left-o+"px",this.lineDiv.appendChild(i);var a=i.getBoundingClientRect();a.right>r.right&&(o=a.right-r.right,i.style.left=n.left-r.left-o+"px"),i.style.top=n.top-r.top-a.height+"px",this.tooltipIndicator.style.marginLeft=o+"px"},ee.prototype.hideInfo=function(){this.tooltipDiv.parentElement==this.lineDiv&&this.lineDiv.removeChild(this.tooltipDiv)};var te,ne=u("Hover",ee,F),re=Object.freeze({defaultConvertor:I,defaultOption:F,suggestedOption:J,Hover:ee,getAddon:ne}),ie=function(e,t){var n=e.text,r=e.type,i=e.url,o=e.pos;if("url"===r||"link"===r){var a=n.match(/\[[^\[\]]+\](?:\[\])?$/);a&&e.altKey?("[]"===(n=a[0]).slice(-2)&&(n=n.slice(0,-2)),r="footref"):(e.ctrlKey||e.altKey)&&i&&window.open(i,"_blank")}if("todo"===r){var l=x(t,o,"formatting-task"),s=l.from,d=l.to,c=t.getRange(s,d);c="[ ]"===c?"[x]":"[ ]",t.replaceRange(c,s,d)}if("footref"===r&&(e.ctrlKey||e.altKey)){var h=n.slice(1,-1),u=t.hmdReadLink(h,o.line);u&&(oe(t,u.line,o),t.setCursor({line:u.line,ch:0}))}},oe=(te=null,function(e,t,n){var r,i,o=function(e){if(-1==e.options.gutters.indexOf("HyperMD-goback"))return null;var t=document.createElement("div");t.className="HyperMD-goback-button",t.addEventListener("click",function(){e.setCursor(te.find()),e.clearGutter("HyperMD-goback"),te.clear(),te=null});var n=e.display.gutters.children;return n=(n=n[n.length-1]).offsetLeft+n.offsetWidth,t.style.width=n+"px",t.style.marginLeft=-n+"px",t}(e);o&&(o.innerHTML=n.line+1+"",r=e,i=n,te&&(r.clearGutter("HyperMD-goback"),te.clear()),te=r.setBookmark(i),e.setGutterMarker(t,"HyperMD-goback",o))}),ae={enabled:!1,handler:null},le={enabled:!0};o.hmdClick=le,q.defineOption("hmdClick",ae,function(e,t){t&&"boolean"!=typeof t?"function"==typeof t&&(t={enabled:!0,handler:t}):t={enabled:!!t};var n=de(e);for(var r in ae)n[r]=r in t?t[r]:ae[r]});var se=function(e){var T=this;this.cm=e,this._keyUp=function(e){var t=e.keyCode||e.which,n="";17==t&&(n="HyperMD-with-ctrl"),18==t&&(n="HyperMD-with-alt"),n||!T._hadAlt||e.altKey||(T._hadAlt=!1,n="HyperMD-with-alt"),n&&i(T.el,n)},this._keyDown=function(e){var t=e.keyCode||e.which,n="";17==t&&(n="HyperMD-with-ctrl"),18==t&&(n="HyperMD-with-alt"),18==t&&(T._hadAlt=!0),n&&r(T.el,n)},this._mouseUp=function(e){var t=T._cinfo;T.lineDiv.removeEventListener("mouseup",T._mouseUp,!1),5<Math.abs(e.clientX-t.clientX)||5<Math.abs(e.clientY-t.clientY)||"function"==typeof T.handler&&!1===T.handler(t,T.cm)||ie(t,T.cm)},this._mouseDown=function(e){var t=e.button,n=e.clientX,r=e.clientY,i=e.ctrlKey,o=e.altKey,a=e.shiftKey,l=T.cm;if("PRE"!==e.target.tagName){var s,d,c,h,u=l.coordsChar({left:n,top:r},"window"),f=l.getTokenAt(u),m=f.state,p=" "+f.type+" ",g=null;if(d=p.match(/\s(image|link|url)\s/)){g=d[1];var v,y=/\shmd-barelink\s/.test(p);if(m.linkText?(s=x(l,u,function(e){return e.state.linkText||/(?:\s|^)link(?:\s|$)/.test(e.type)}),g="link"):s=x(l,u,g),/^(?:image|link)$/.test(g)&&!y){var b=x(l,{line:u.line,ch:s.to.ch+1},"url");b&&(s.to=b.to)}if(")"===(c=l.getRange(s.from,s.to).trim()).slice(-1)&&-1!==(v=c.lastIndexOf("](")))h=C(c.slice(v+2,-1)).url;else if((d=c.match(/[^\\]\]\s?\[([^\]]+)\]$/))||(d=c.match(/^\[(.+)\]\s?\[\]$/))||(d=c.match(/^\[(.+)\](?:\:\s*)?$/))){y&&"^"===d[1].charAt(0)&&(g="footref");var k=l.hmdReadLink(d[1],u.line);h=k?C(k.content).url:null}else((d=c.match(/^\<(.+)\>$/))||(d=c.match(/^\((.+)\)$/))||(d=[null,c]))&&(h=d[1]);h=l.hmdResolveURL(h)}else p.match(/\sformatting-task\s/)&&(g="todo",(s=x(l,u,"formatting-task")).to.ch=l.getLine(u.line).length,c=l.getRange(s.from,s.to),h=null);null!==g&&(T._cinfo={type:g,text:c,url:h,pos:u,button:t,clientX:n,clientY:r,ctrlKey:i,altKey:o,shiftKey:a},T.lineDiv.addEventListener("mouseup",T._mouseUp,!1))}},this.lineDiv=e.display.lineDiv;var t=this.el=e.getWrapperElement();new s(function(){T.lineDiv.addEventListener("mousedown",T._mouseDown,!1),t.addEventListener("keydown",T._keyDown,!1),t.addEventListener("keyup",T._keyUp,!1)},function(){T.lineDiv.removeEventListener("mousedown",T._mouseDown,!1),t.removeEventListener("keydown",T._keyDown,!1),t.removeEventListener("keyup",T._keyUp,!1)}).bind(this,"enabled",!0)},de=u("Click",se,ae),ce=Object.freeze({defaultClickHandler:ie,defaultOption:ae,suggestedOption:le,Click:se,getAddon:de}),he={enabled:!1,convertor:null},ue={enabled:!0};o.hmdPaste=ue,q.defineOption("hmdPaste",he,function(e,t){t&&"boolean"!=typeof t?"function"==typeof t&&(t={enabled:!0,convertor:t}):t={enabled:!!t};var n=ge(e);for(var r in he)n[r]=r in t?t[r]:he[r]});var fe,me,pe=function(e){var o=this;this.cm=e,this.pasteHandler=function(e,t){var n=t.clipboardData||window.clipboardData,r=o.convertor;if(r&&n&&-1!=n.types.indexOf("text/html")){var i=r(n.getData("text/html"));i&&(e.operation(e.replaceSelection.bind(e,i)),t.preventDefault())}},new s(function(){e.on("paste",o.pasteHandler)},function(){e.off("paste",o.pasteHandler)}).bind(this,"enabled",!0)},ge=u("Paste",pe,he),ve=Object.freeze({defaultOption:he,suggestedOption:ue,Paste:pe,getAddon:ge});(me=fe||(fe={})).OK="ok",me.CURSOR_INSIDE="ci",me.HAS_MARKERS="hm";var ye={image:function(e,t){var n=e.cm,r=/\bformatting-link-string\b/;if(/\bimage-marker\b/.test(t.type)&&"!"===t.string){var i=e.lineNo,o=e.findNext(r),a=e.findNext(r,o.i_token+1),l={line:i,ch:t.start},s={line:i,ch:a.token.end},d=e.requestRange(l,s);if(d===fe.OK){var c,h,u=n.getRange({line:i,ch:o.token.start+1},{line:i,ch:a.token.start});if("]"===a.token.string){var f=n.hmdReadLink(u,i);if(!f)return null;u=f.content}c=C(u).url,c=n.hmdResolveURL(c),h=n.getRange({line:i,ch:l.ch+2},{line:i,ch:o.token.start-1});var m=document.createElement("img"),p=n.markText(l,s,{collapsed:!0,replacedWith:m});return m.addEventListener("load",function(){m.classList.remove("hmd-image-loading"),p.changed()},!1),m.addEventListener("error",function(){m.classList.remove("hmd-image-loading"),m.classList.add("hmd-image-error"),p.changed()},!1),m.addEventListener("click",function(){return be(n,p)},!1),m.className="hmd-image hmd-image-loading",m.src=c,m.title=h,p}}return null},link:function(e,t){var n=e.cm,r=/\bformatting-link-string\b/;if("("===t.string&&r.test(t.type)&&(0===e.i_token||!/\bimage/.test(e.lineTokens[e.i_token-1].type))){var i=e.lineNo,o=e.findNext(function(e){return r.test(e.type)&&")"===e.string}),a={line:i,ch:t.start},l={line:i,ch:o.token.end},s=e.requestRange(a,l);if(s===fe.OK){var d=n.getRange(a,l),c=C(d.substr(1,d.length-2)),h=c.url,u=c.title,f=document.createElement("span");f.setAttribute("class","hmd-link-icon"),f.setAttribute("title",h+"\n"+u),f.setAttribute("data-url",h);var m=n.markText(a,l,{collapsed:!0,replacedWith:f});return f.addEventListener("click",function(){return be(n,m)},!1),m}}return null}};function be(t,n,r){t.operation(function(){var e=n.find().from;e={line:e.line,ch:e.ch+~~r},t.setCursor(e),t.focus(),n.clear()})}var ke={image:!1,link:!1,math:!1,html:!1,customFolders:{}},Te={image:!0,link:!0,math:!0,html:!1};o.hmdFold=Te,q.defineOption("hmdFold",ke,function(e,t){if(!t||"boolean"==typeof t){var n=!!t;for(var r in t={},ye)t[r]=n}var i=we(e);for(var o in ye)i.setBuiltinStatus(o,t[o]);"object"!=typeof t.customFolders&&(t.customFolders={});var a=[];for(var l in t.customFolders)t.customFolders.hasOwnProperty(l)&&(a.push(l),l in i.folded||(i.folded[l]=[]));i.customFolderTypes=a,i.startFold()});var Le=function(t){function e(e){var n=this;t.call(this,e),this.cm=e,this.ff_builtin={},this.folded={},this.startFold=h(this.startFoldImmediately.bind(this),100),this._quickFoldHint=[],e.on("changes",function(e,t){t.reduce(function(e,t){return Math.min(e,t.from.line)},e.lastLine());n.startFold()}),e.on("cursorActivity",function(e){n.startQuickFold()})}return t&&(e.__proto__=t),((e.prototype=Object.create(t&&t.prototype)).constructor=e).prototype.setBuiltinStatus=function(e,t){if(e in ye){var n=this.ff_builtin[e];n||(n=new s(this.startFold,this.clear.bind(this,e)),this.ff_builtin[e]=n),n.setBool(t)}},e.prototype.requestRange=function(e,t){var n=this.cm,r=q.cmpPos,i=n.getCursor(),o=n.findMarks(e,t),a=fe.OK;return 0!==o.length?a=fe.HAS_MARKERS:0<=r(i,e)&&r(i,t)<=0&&(a=fe.CURSOR_INSIDE),a!==fe.OK&&this._quickFoldHint.push(e.line),a},e.prototype.startFoldImmediately=function(e,t){var b=this,n=this.cm;e=e||n.firstLine(),t=(t||n.lastLine())+1,this._quickFoldHint=[],this.setPos(e,0,!0),n.operation(function(){return n.eachLine(e,t,function(e){var t=e.lineNo();if(!(t<b.lineNo)){t>b.lineNo&&b.setPos(t,0);var n=new Array(e.text.length),r=e.markedSpans;if(r)for(var i=0;i<r.length;++i)for(var o=r[i],a=null==o.from?0:o.from,l=null==o.to?n.length:o.to,s=a;s<l;s++)n[s]=!0;for(var d=b.lineTokens;b.i_token<d.length;){for(var c,h=d[b.i_token],u=null,f=!0,m=h.start;m<h.end;m++)if(n[m]){f=!1;break}if(f){for(c in b.ff_builtin)if(b.ff_builtin[c].state&&(u=ye[c](b,h)))break;if(!u)for(var p=0,g=b.customFolderTypes;p<g.length&&(c=g[p],!(u=b.customFolders[c](b,h)));p+=1);}if(u){var v=u.find(),y=(v.from,v.to);if((b.folded[c]||(b.folded[c]=[])).push(u),u.on("clear",function(e,t){var n,r=b.folded[c];r&&-1!==(n=r.indexOf(u))&&r.splice(n,1),b._quickFoldHint.push(e.line)}),y.line!==t)return void b.setPos(y.line,y.ch);b.setPos(y.ch)}else b.i_token++}}})})},e.prototype.startQuickFold=function(){var e=this._quickFoldHint;if(0!==e.length){for(var t=e[0],n=t,r=0,i=e;r<i.length;r+=1){var o=i[r];o<t&&(t=o),n<o&&(n=o)}this.startFold.stop(),this.startFoldImmediately(t,n)}},e.prototype.clear=function(e){this.startFold.stop();var t=this.folded[e];if(t&&t.length)for(var n;n=t.pop();)n.clear()},e.prototype.clearAll=function(){for(var e in this.startFold.stop(),this.folded)for(var t,n=this.folded[e];t=n.pop();)t.clear()},e}(U),we=u("Fold",Le,ke),xe=Object.freeze({get RequestRangeResult(){return fe},builtinFolder:ye,breakMark:be,defaultOption:ke,suggestedOption:Te,Fold:Le,getAddon:we}),Me=function(e,t){var n=/formatting-math-begin\b/;if(!n.test(t.type))return null;var r=e.cm,i=e.lineNo,o=/math-2\b/.test(t.type),a=o?2:1;if(2==a&&1==t.string.length){0;var l=e.lineTokens[e.i_token+1];if(!l||!n.test(l.type))return null}var s,d=e.findNext(/formatting-math-end\b/,o),c={line:i,ch:t.start},h=!1;if(d)s={line:d.lineNo,ch:d.token.start+a};else{if(!o)return null;var u=r.lastLine();s={line:u,ch:r.getLine(u).length},h=!0}var f={line:c.line,ch:c.ch+a},m={line:s.line,ch:s.ch-(h?0:a)},p=r.getRange(f,m).trim(),g=De(r),v=e.requestRange(c,s);if(v!==fe.OK)return v===fe.CURSOR_INSIDE&&(g.editingExpr=p),null;var y=Se(r,c,s,p,a,"math-"+a);return g.editingExpr=null,y};function Se(e,t,n,r,i,o){var a=document.createElement("span");a.setAttribute("class","hmd-fold-math "+(o||"")),a.setAttribute("title",r);var l=document.createElement("span");l.setAttribute("class","hmd-fold-math-placeholder"),l.textContent=r,a.appendChild(l);var s=e.markText(t,n,{className:"hmd-fold-math",replacedWith:a,clearOnEnter:!0});a.addEventListener("click",function(){return be(e,s,i)},!1);var d=De(e).createRenderer(a,1<i?"display":"");return d.onChanged=function(){l&&(a.removeChild(l),l=null),s.changed()},s.on("clear",function(){d.clear()}),s.mathRenderer=d,c(function(){return!!d.isReady()&&(d.startRender(r),!0)},5,function(){s.clear()}),s}ye.math=Me;var Ce=function(e,t){var n=this;this.container=e;var r=document.createElement("img");r.setAttribute("class","hmd-math-dumb"),r.addEventListener("load",function(){n.onChanged&&n.onChanged(n.last_expr)},!1),this.img=r,e.appendChild(r)};Ce.prototype.startRender=function(e){this.last_expr=e,this.img.src="https://latex.codecogs.com/gif.latex?"+encodeURIComponent(e)},Ce.prototype.clear=function(){this.container.removeChild(this.img)},Ce.prototype.isReady=function(){return!0};var Oe={renderer:Ce,onPreview:null,onPreviewEnd:null},He={};o.hmdFoldMath=He,q.defineOption("hmdFoldMath",Oe,function(e,t){t?"function"==typeof t&&(t={renderer:t}):t={};var n=De(e);for(var r in Oe)n[r]=r in t?t[r]:Oe[r]});var Ae=function(e){var t=this;this.cm=e,new s(function(e){t.onPreview&&t.onPreview(e)},function(){t.onPreviewEnd&&t.onPreviewEnd()},null).bind(this,"editingExpr")};Ae.prototype.createRenderer=function(e,t){return new(this.renderer||Ce)(e,t)};var De=u("FoldMath",Ae,Oe),Ne=Object.freeze({MathFolder:Me,insertMathMark:Se,DumbRenderer:Ce,defaultOption:Oe,suggestedOption:He,FoldMath:Ae,getAddon:De}),Re=function(e){return!/^<(?:br)/i.test(e)&&(!/<(?:script|style|link|meta)/i.test(e)&&(!/\son\w+\s*=/i.test(e)&&!/src\s*=\s*["']?javascript:/i.test(e)))},Ee=function(e,t,a){var n=/^<(\w+)\s*/.exec(e);if(!n)return null;for(var r,i=n[1],o=document.createElement(i),l=/([\w\:\-]+)(?:\s*=\s*((['"]).*?\3|\S+))?\s*/g,s=l.lastIndex=n[0].length;(r=l.exec(e))&&!(r.index>s);){var d=r[1],c=r[2];c&&/^['"]/.test(c)&&(c=c.slice(1,-1)),o.setAttribute(d,c),s=l.lastIndex}if("innerHTML"in o){var h=e.indexOf(">",s)+1,u=e.length;(r=new RegExp("</"+i+"\\s*>\\s*$","i").exec(e))&&(u=r.index);var f=e.slice(h,u);f&&(o.innerHTML=f),m([o],function(e){var t=e.tagName.toLowerCase();"a"===t&&(e.getAttribute("target")||e.setAttribute("target","_blank"));var n={a:["href"],img:["src"],iframe:["src"]}[t];if(n)for(var r=0;r<n.length;r++){var i=n[r],o=e.getAttribute(i);o&&e.setAttribute(i,a.hmdResolveURL(o))}})}return o},_e="hmd-fold-html-stub",Ie=function(e,t){if(!t.type||!/ hmd-html-begin/.test(t.type))return null;var n=e.findNext(/ hmd-html-\w+/,!0);if(!n||!/ hmd-html-end/.test(n.token.type)||/ hmd-html-unclosed/.test(n.token.type))return null;var r=e.cm,i={line:e.lineNo,ch:t.start},o={line:n.lineNo,ch:n.token.end},a=0!=i.ch||o.ch<r.getLine(o.line).length;if(!a)for(var l=r.lastLine()-1,s=1;0<s&&o.line<l;){var d=r.getLine(o.line+1);if(!/^\s*$/.test(d))break;o.line++,o.ch=d.length,s--}var c=$e(r),h=r.getRange(i,o);return c.checker(h,i,r)?e.requestRange(i,o)!==fe.OK?null:c.renderAndInsert(h,i,o,a):null};ye.html=Ie;var Fe={checker:Re,renderer:Ee,stubText:"<HTML>",isolatedTagName:/^(?:div|pre|form|table|iframe|ul|ol|input|textarea|p|summary|a)$/i},Pe={};o.hmdFoldHTML=Pe,q.defineOption("hmdFoldHTML",Fe,function(e,t){t?"function"==typeof t?t={checker:t}:"object"!=typeof t&&(console.warn("[HyperMD][FoldHTML] incorrect option value type"),t={}):t={};var n=$e(e);for(var r in Fe)n[r]=r in t?t[r]:Fe[r];!n.isolatedTagName||n.isolatedTagName instanceof RegExp||(console.error("[HyperMD][FoldHTML] option isolatedTagName only accepts RegExp"),n.isolatedTagName=Fe.isolatedTagName)});var je=function(e){this.cm=e};je.prototype.renderAndInsert=function(e,t,n,r){var i,o,a=this.cm,l=this.makeStub(),s=this.renderer(e,t,a),d=function(){return be(a,o)};if(!s)return null;if(l.addEventListener("click",d,!1),s.tagName.match(this.isolatedTagName||/^$/)||s.addEventListener("click",d,!1),r){var c=document.createElement("span");c.setAttribute("class","hmd-fold-html"),c.setAttribute("style","display: inline-block"),c.appendChild(l),c.appendChild(s),i=c,(h=p(s,function(e,t){var n=getComputedStyle(s),r=function(e){return n.getPropertyValue(e)},i=e<10||t<10||!/^relative|static$/i.test(r("position"))||!/^none$/i.test(r("float"));l.className=i?_e:"hmd-fold-html-stub hmd-fold-html-stub-omittable",o.changed()})).check(),setTimeout(function(){o.on("clear",function(){h.stop()})},0)}else{i=l;var h,u=a.addLineWidget(n.line,s,{above:!1,coverGutter:!1,noHScroll:!1,showIfHidden:!1}),f=function(){return l.className="hmd-fold-html-stub hmd-fold-html-stub-highlight"},m=function(){return l.className=_e};s.addEventListener("mouseenter",f,!1),s.addEventListener("mouseleave",m,!1),(h=p(s,function(){return u.changed()})).check(),setTimeout(function(){o.on("clear",function(){h.stop(),u.clear(),s.removeEventListener("mouseenter",f,!1),s.removeEventListener("mouseleave",m,!1)})},0)}return o=a.markText(t,n,{clearOnEnter:!0,replacedWith:i})},je.prototype.makeStub=function(){var e=document.createElement("span");return e.setAttribute("class",_e),e.textContent=this.stubText||"<HTML>",e};var $e=u("FoldHTML",je,Fe),qe=Object.freeze({defaultChecker:Re,defaultRenderer:Ee,HTMLFolder:Ie,defaultOption:Fe,suggestedOption:Pe,FoldHTML:je,getAddon:$e}),ze={enabled:!1},Ue={enabled:!0};o.hmdTableAlign=Ue,q.defineOption("hmdTableAlign",ze,function(e,t){var n=!!t;n&&"boolean"!=typeof t||(t={enabled:n});var r=Be(e);for(var i in ze)r[i]=i in t?t[i]:ze[i]});var Ke=function(e){var p=this;this.cm=e,this.styleEl=document.createElement("style"),this.updateStyle=h(function(){if(p.enabled){var e=p.cm,t=p.measure(),n=p.makeCSS(t);n!==p._lastCSS&&(p.styleEl.textContent=p._lastCSS=n,setTimeout(function(){return d(e)},50))}},100),this._procLine=function(e,t,n){if(n.querySelector(".cm-hmd-table-sep")){for(var r=n.firstElementChild,i=Array.prototype.slice.call(r.childNodes,0),o=e.getStateAfter(t.lineNo()),a=o.hmdTableColumns,l=o.hmdTableID,s=2===o.hmdTable?-1:0,d=p.makeColumn(s,a[s]||"dummy",l),c=d.firstElementChild,h=0,u=i;h<u.length;h+=1){var f=u[h],m=f.nodeType===Node.ELEMENT_NODE&&f.className||"";/cm-hmd-table-sep/.test(m)?(s++,d.appendChild(c),r.appendChild(d),r.appendChild(f),c=(d=p.makeColumn(s,a[s]||"dummy",l)).firstElementChild):c.appendChild(f)}d.appendChild(c),r.appendChild(d)}},new s(function(){e.on("renderLine",p._procLine),e.on("update",p.updateStyle),e.refresh(),document.head.appendChild(p.styleEl)},function(){e.off("renderLine",p._procLine),e.off("update",p.updateStyle),document.head.removeChild(p.styleEl)}).bind(this,"enabled",!0)};Ke.prototype.makeColumn=function(e,t,n){var r=document.createElement("span");r.className="hmd-table-column hmd-table-column-"+e+" hmd-table-column-"+t,r.setAttribute("data-column",""+e),r.setAttribute("data-table-id",n);var i=document.createElement("span");return i.className="hmd-table-column-content",i.setAttribute("data-column",""+e),r.appendChild(i),r},Ke.prototype.measure=function(){for(var e=this.cm.display.lineDiv.querySelectorAll(".hmd-table-column-content"),t={},n=0;n<e.length;n++){var r=e[n],i=r.parentElement,o=i.getAttribute("data-table-id"),a=~~i.getAttribute("data-column"),l=r.offsetWidth+1;o in t||(t[o]=[]);for(var s=t[o];s.length<=a;)s.push(0);s[a]<l&&(s[a]=l)}return t},Ke.prototype.makeCSS=function(e){var t=[];for(var n in e)for(var r=e[n],i="pre.HyperMD-table-row.HyperMD-table_"+n+" .hmd-table-column-",o=0;o<r.length;o++){var a=r[o];t.push(""+i+o+" { min-width: "+a+"px }")}return t.join("\n")};var Be=u("TableAlign",Ke,ze),Xe=Object.freeze({defaultOption:ze,suggestedOption:Ue,TableAlign:Ke,getAddon:Be}),We={source:null},Ye={source:"function"==typeof requirejs?"~codemirror/":"https://cdn.jsdelivr.net/npm/codemirror/"};o.hmdModeLoader=Ye,q.defineOption("hmdModeLoader",We,function(e,t){t&&"boolean"!=typeof t?"string"!=typeof t&&"function"!=typeof t||(t={source:t}):t={source:t&&Ye.source||null};var n=Ve(e);for(var r in We)n[r]=r in t?t[r]:We[r]});var Ge=function(e){var l=this;this.cm=e,this._loadingModes={},this.rlHandler=function(e,t){var n=t.lineNo(),r=(t.text||"").match(/^```\s*(\S+)/);if(r){var i=r[1],o=q.findModeByName(i),a=o&&o.mode;!a||a in q.modes||l.startLoadMode(a,n)}},(new s).bind(this,"source").ON(function(){e.on("renderLine",l.rlHandler)}).OFF(function(){e.off("renderLine",l.rlHandler)})};Ge.prototype.touchLine=function(e){var t=this.cm.getLineHandle(e),n=t.text.length;this.cm.replaceRange(t.text.charAt(n-1),{line:e,ch:n-1},{line:e,ch:n})},Ge.prototype.startLoadMode=function(e,t){var n=this._loadingModes,r=this;if(0<=t&&e in n)n[e].push(t);else{0<=t&&(n[e]=[t]);var i=function(){console.log("[HyperMD] mode-loader loaded "+e);var t=n[e];r.cm.operation(function(){for(var e=0;e<t.length;e++)r.touchLine(t[e])}),delete n[e]},o=function(){console.warn("[HyperMD] mode-loader failed to load mode "+e+" from ",a),-1!==t&&(console.log("[HyperMD] mode-loader will retry loading "+e),setTimeout(function(){r.startLoadMode(e,0<=t?-3:t+1)},1e3))};if("function"!=typeof this.source){var a=this.source+"mode/"+e+"/"+e+".js";if("function"==typeof requirejs&&"~"===a.charAt(0))requirejs([a.slice(1,-3)],i);else{var l=document.createElement("script");l.onload=i,l.onerror=o,l.src=a,document.head.appendChild(l)}}else this.source(e,i,o)}};var Ve=u("ModeLoader",Ge,We),Ze=Object.freeze({defaultOption:We,suggestedOption:Ye,ModeLoader:Ge,getAddon:Ve}),Qe={enabled:!1,line:!0,tokenTypes:"em|strong|strikethrough|code|link|task".split("|")},Je={enabled:!0};o.hmdHideToken=Je,q.defineOption("hmdHideToken",Qe,function(e,t){t&&"boolean"!=typeof t?"string"==typeof t?t={enabled:!0,tokenTypes:t.split("|")}:t instanceof Array&&(t={enabled:!0,tokenTypes:t}):t={enabled:!!t};var n=rt(e);for(var r in Qe)n[r]=r in t?t[r]:Qe[r]});var et="hmd-hidden-token",tt="hmd-inactive-line",nt=function(e){var r=this;this.cm=e,this.shownTokensStart={},this.renderLineHandler=function(e,t,n){r.procLine(t,n)},this.cursorActivityHandler=function(e){r.update()},this.update=h(function(){return r.updateImmediately()},100),new s(function(){e.on("cursorActivity",r.cursorActivityHandler),e.on("renderLine",r.renderLineHandler),e.on("update",r.update),r.update(),e.refresh()},function(){e.off("cursorActivity",r.cursorActivityHandler),e.off("renderLine",r.renderLineHandler),e.off("update",r.update),r.update.stop(),e.refresh()}).bind(this,"enabled",!0)};nt.prototype.calcShownTokenStart=function(){var e=this.cm,t=e.getCursor(),n=this.tokenTypes,r=new RegExp("\\sformatting-("+n.join("|")+")\\s"),i={},o=e.getLineTokens(t.line),a=-1,l=[],s=null,d=[];for(var c=0;c<o.length;c++){var h=o[c];-1===a&&(h.end>t.ch||c===o.length-1)&&(a=c);var u=h.type&&h.type.match(r);if(u){var f=u[1];if(f!==s){var m=l[l.length-1];if(m&&m[1]===f){if(l.pop(),-1!==a||h.end===t.ch){d.push(m[0],h);break}}else if(l.push([h,f]),-1!==a){d.push(h);var p=new RegExp("\\sformatting-"+f+"\\s");for(c+=1;c<o.length;c++){var g=o[c];if(g.type&&p.test(g.type)){d.push(g);break}}break}0,s=f}}else{if(-1!==a){if(0<l.length){var v=l.pop(),y=v[0],b=v[1],k=new RegExp("\\sformatting-"+b+"\\s");for(d.push(y),c+=1;c<o.length;c++){var T=o[c];if(T.type&&k.test(T.type)){d.push(T);break}}}break}s=null}if(-1!==a&&0===l.length)break}for(var L=i[t.line]=[],w=0,x=d;w<x.length;w+=1){var M=x[w];L.push(M.start)}if(c>=o.length-1)for(var S=0,C=l;S<C.length;S+=1){var O=C[S][0].start;-1===L.indexOf(O)&&L.push(O)}return i},nt.prototype.procLine=function(e,t){if(!e)return-1;var n=this.cm,r=e.lineNo(),i=L(n,r);if(!i||i.hidden||!i.measure)return-1;for(var o=w(i,e,r).map,a=o.length/3,l=(r in this.shownTokensStart?this.shownTokensStart[r].slice().sort(function(e,t){return e-t}):null),s=-1,d=0,c=0;d<a;d++,c+=3){var h=o[c],u=(o[c+1],o[c+2]),f=u.parentElement;if(u.nodeType===Node.TEXT_NODE&&f&&/^span$/i.test(f.nodeName))for(var m=f.className,p=0,g=this.tokenTypes;p<g.length;p+=1){var v=g[p];if(("link"!==v||!/(?:^|\s)(?:cm-hmd-footref|cm-hmd-footnote|cm-hmd-barelink)(?:\s|$)/.test(m))&&-1!==m.indexOf("cm-formatting-"+v+" ")){var y=!0;if(l&&0<l.length){for(;l[0]<h;)l.shift();y=l[0]!==h}y?-1===m.indexOf(et)&&(f.className+=" "+et,-1===s&&(s=h)):-1!==m.indexOf(et)&&(f.className=m.replace(et,""),-1===s&&(s=h));break}}}if(this.line&&(t=t||i.text)){var b=t.className,k=-1===b.indexOf(tt),T=null!==l;k!=T&&(t.className=T?b.replace(tt,""):b+" "+tt,s=0)}return-1!==s&&i.measure.cache&&(i.measure.cache={}),s},nt.prototype.updateImmediately=function(){var i=this,o=this.cm,a=o.getCursor(),e=this.shownTokensStart,t=this.shownTokensStart=this.enabled?this.calcShownTokenStart():{},l=!1,s=[];for(var n in e)s.push(~~n);for(var r in t)s.push(~~r);s.sort(function(e,t){return e-t}),o.operation(function(){for(var e=-1,t=0,n=s;t<n.length;t+=1){var r=n[t];if(r!==e)e=r,-1!==i.procLine(o.getLineHandle(r))&&a.line===r&&(l=!0)}l&&(d(o,!0),o.hmd.TableAlign&&o.hmd.TableAlign.enabled&&o.hmd.TableAlign.updateStyle())})};var rt=u("HideToken",nt,Qe),it=Object.freeze({defaultOption:Qe,suggestedOption:Je,HideToken:nt,getAddon:rt}),ot={enabled:!1},at={enabled:!0};o.hmdCursorDebounce=at,q.defineOption("hmdCursorDebounce",ot,function(e,t){t&&"boolean"!=typeof t||(t={enabled:!!t});var n=st(e);for(var r in ot)n[r]=r in t?t[r]:ot[r]});var lt=function(e){var r=this;this.cm=e,this.mouseDownHandler=function(e,t){r.lastX=t.clientX,r.lastY=t.clientY;var n=r.mouseMoveSuppress;document.addEventListener("mousemove",n,!0),r.lastTimeout&&clearTimeout(r.lastTimeout),r.lastTimeout=setTimeout(function(){document.removeEventListener("mousemove",n,!0),r.lastTimeout=null},100)},this.mouseMoveSuppress=function(e){Math.abs(e.clientX-r.lastX)<=5&&Math.abs(e.clientY-r.lastY)<=5&&e.stopPropagation()},new s(function(){e.on("mousedown",r.mouseDownHandler)},function(){e.off("mousedown",r.mouseDownHandler)}).bind(this,"enabled",!0)},st=u("CursorDebounce",lt,ot),dt=Object.freeze({defaultOption:ot,suggestedOption:at,CursorDebounce:lt,getAddon:st}),ct=/^(\s*)(>[> ]*|[*+-] \[[x ]\]\s|[*+-]\s|(\d+)([.)]))(\s*)/,ht=/^(\s*)(>[> ]*|[*+-] \[[x ]\]|[*+-]|(\d+)[.)])(\s*)$/,ut=/[*+-]\s/,ft=/^(\s*)([*+-]\s|(\d+)([.)]))(\s*)/,mt=function(e){return/hmd-table-sep/.test(e.type)&&!/hmd-table-sep-dummy/.test(e.type)};function pt(e){if(e.getOption("disableInput"))return q.Pass;for(var t=[],n=0,r=e.listSelections();n<r.length;n+=1){var i=r[n],o=i.head,a=i.empty(),l=e.getStateAfter(o.line),s=e.getLine(o.line),d=!1;if(!d){var c=!1!==l.list,h=l.quote,u=ct.exec(s),f=/^\s*$/.test(s.slice(0,o.ch));if(a&&(c||h)&&u&&!f)if(d=!0,ht.test(s))/>\s*$/.test(s)||e.replaceRange("",{line:o.line,ch:0},{line:o.line,ch:o.ch+1}),t.push("\n");else{var m=u[1],p=u[5],g=!(ut.test(u[2])||0<=u[2].indexOf(">")),v=g?parseInt(u[3],10)+1+u[4]:u[2].replace("x"," ");t.push("\n"+m+v+p),g&&Tt(e,o)}}if(!d){var y=a?l.hmdTable:0;if(0!=y){if(!/^[\s\|]+$/.test(s)||o.line!==e.lastLine()&&e.getStateAfter(o.line+1).hmdTable===y){var b=z("  |  ",l.hmdTableColumns.length-1),k="\n";2===y&&(k+="| ",b+=" |"),0==l.hmdTableRow?e.setCursor({line:o.line+1,ch:e.getLine(o.line+1).length}):e.setCursor({line:o.line,ch:s.length}),e.replaceSelection(k),e.replaceSelection(b,"start")}else e.setCursor({line:o.line,ch:0}),e.replaceRange("\n",{line:o.line,ch:0},{line:o.line,ch:s.length});return void(d=!0)}if(a&&o.ch>=s.length&&!l.code&&!l.hmdInnerMode&&/^\|.+\|.+\|$/.test(s)){for(var T=e.getLineTokens(o.line),L="|",w="|",x=1;x<T.length;x++){var M=T[x];"|"!==M.string||M.type&&M.type.trim().length||(L+=" ------- |",w+="   |")}return e.setCursor({line:o.line,ch:s.length}),e.replaceSelection("\n"+L+"\n| "),e.replaceSelection(w.slice(1)+"\n","start"),void(d=!0)}}if(d||a&&"$$"==s.slice(o.ch-2,o.ch)&&/math-end/.test(e.getTokenTypeAt(o))&&(t.push("\n"),d=!0),!d)return void e.execCommand("newlineAndIndent")}e.replaceSelections(t)}function gt(e){if(e.getOption("disableInput"))return q.Pass;for(var t=e.listSelections(),n=a("\n",t.length),r=0;r<t.length;r++){var i=t[r].head,o=e.getStateAfter(i.line);!1!==o.list&&(n[r]+=z(" ",o.listStack.slice(-1)[0]))}e.replaceSelections(n)}function vt(e,t,n){if(n&&!(n<0)){var r=/^ */.exec(e.getLine(t))[0].length;r<n&&(n=r),0<n&&e.replaceRange("",{line:t,ch:0},{line:t,ch:n})}}function yt(e){for(var t,n=e.listSelections(),r=new U(e),i=0;i<n.length;i++){var o=n[i],a=o.head,l=o.anchor;!o.empty()&&0<q.cmpPos(a,l)?(l=(t=[a,l])[0],a=t[1]):l===a&&(l=o.anchor={ch:a.ch,line:a.line});var s=e.getStateAfter(a.line);if(s.hmdTable){r.setPos(a.line,a.ch);var d=2===s.hmdTable,c=a.line,h=e.getLine(c),u=0,f=0,m=r.findPrev(mt);if(m){u=(p=r.findPrev(mt,m.i_token-1))?p.token.end:0,f=m.token.start,0==u&&d&&(u+=h.match(/^\s*\|/)[0].length)}else{if(0==s.hmdTableRow)return;var p;2==s.hmdTableRow&&c--,c--,h=e.getLine(c),r.setPos(c,h.length),u=(p=r.findPrev(mt)).token.end,f=h.length,d&&(f-=h.match(/\|\s*$/)[0].length)}return" "===h.charAt(u)&&(u+=1),0<u&&" |"===h.substr(u-1,2)&&u--," "===h.charAt(f-1)&&(f-=1),void e.setSelection({line:c,ch:u},{line:c,ch:f})}if(0<s.listStack.length){for(var g=a.line;!ft.test(e.getLine(g));){if(g--,!(0<e.getStateAfter(g).listStack.length)){g++;break}}for(var v=e.lastLine(),y=void 0;g<=l.line&&(y=ft.exec(e.getLine(g)));g++){var b=e.getStateAfter(g).listStack,k=b.length,T=0;for(vt(e,g,T=1==k?y[1].length:b[k-1]-(b[k-2]||0));++g<=v;){if(e.getStateAfter(g).listStack.length!==k){g=1/0;break}if(ft.test(e.getLine(g))){g--;break}vt(e,g,T)}}return}}e.execCommand("indentLess")}function bt(e){var t,n=e.listSelections(),r=[],i=[],o=[],a={},l=new U(e),s=!1,d=!1,c=!1,h=!0;function u(e){(r[p]=e)&&(d=!0)}function f(e){(i[p]=e)&&(c=!0)}function m(e){(o[p]=e)&&(h=!0)}for(var p=0;p<n.length;p++){r[p]=i[p]=o[p]="";var g=n[p],v=g.head,y=g.anchor,b=g.empty();!b&&0<q.cmpPos(v,y)?(y=(t=[v,y])[0],v=t[1]):y===v&&(y=g.anchor={ch:v.ch,line:v.line});var k=e.getStateAfter(v.line),T=e.getLine(v.line);if(k.hmdTable){s=!0;var L=2===k.hmdTable,w=k.hmdTableColumns;l.setPos(v.line,v.ch);var x=l.findNext(mt,l.i_token);if(x){var M=l.findNext(/hmd-table-sep/,x.i_token+1);v.ch=x.token.end,y.ch=M?M.token.start:T.length,y.ch>v.ch&&" "===T.charAt(v.ch)&&v.ch++,y.ch>v.ch&&" "===T.charAt(y.ch-1)&&y.ch--,m(y.ch>v.ch?e.getRange(v,y):"")}else{var S=0===k.hmdTableRow?2:1;if(v.line+S>e.lastLine()||e.getStateAfter(v.line+S).hmdTable!=k.hmdTable){v.ch=y.ch=T.length;var C=z("  |  ",w.length-1);0===k.hmdTableRow&&(y.line=v.line+=1,y.ch=v.ch=e.getLine(v.line).length),L?(u("\n| "),f(C+" |")):(u("\n"),f(C.trimRight())),m("")}else{y.line=v.line+=S,l.setPos(v.line,0);var O=l.line.text,H=L&&l.findNext(/hmd-table-sep-dummy/,0),A=l.findNext(/hmd-table-sep/,H?H.i_token+1:1);v.ch=H?H.token.end:0,y.ch=A?A.token.start:O.length,y.ch>v.ch&&" "===O.charAt(v.ch)&&v.ch++,y.ch>v.ch&&" "===O.charAt(y.ch-1)&&y.ch--,m(y.ch>v.ch?e.getRange(v,y):"")}}}else if(0<k.listStack.length){for(var D=v.line,N=void 0;!(N=ft.exec(e.getLine(D)));){if(D--,!(0<e.getStateAfter(D).listStack.length)){D++;break}}for(var R=e.firstLine(),E=e.lastLine();D<=y.line&&(N=ft.exec(e.getLine(D)));D++){var _=e.getStateAfter(D).listStack,I=e.getStateAfter(D-1).listStack,F=_.length,P="";for(R<D&&F<=I.length&&(P=F==I.length?z(" ",I[F-1]-N[1].length):z(" ",I[F]-N[0].length)),a[D]=P;++D<=E;){if(e.getStateAfter(D).listStack.length!==F){D=1/0;break}if(ft.test(e.getLine(D))){D--;break}a[D]=P}}if(!b){h=!1;break}}else if(b)u("    ");else{m(e.getRange(v,y));for(var j=v.line;j<=y.line;j++)j in a||(a[j]="    ")}}for(var $ in a)a[$]&&e.replaceRange(a[$],{line:~~$,ch:0});s&&e.setSelections(n),d&&e.replaceSelections(r),c&&e.replaceSelections(i,"start"),h&&e.replaceSelections(o,"around")}function kt(w,x,M){return function(e){var t;if(e.getOption("disableInput"))return q.Pass;for(var n=new U(e),r=e.listSelections(),i=new Array(r.length),o=0;o<r.length;o++){var a=r[o],l=a.head,s=a.anchor,d=e.getStateAfter(l.line),c=a.empty();0<q.cmpPos(l,s)&&(s=(t=[l,s])[0],l=t[1]);var h=i[o]=c?"":e.getRange(l,s);if(c||w(e.getTokenAt(l).state)){var u=l.line;n.setPos(u,l.ch,!0);var f=n.lineTokens[n.i_token];f&&f.state;f&&!/^\s*$/.test(f.string)||(f=n.lineTokens[--n.i_token]);var m=n.expandRange(function(e){return e&&(w(e.state)||x(e))}),p=m.from,g=m.to;if(g.i_token===p.i_token){var v=M();if(f&&!/^\s*$/.test(f.string)){var y={line:u,ch:f.start},b={line:u,ch:f.end};return f=p.token,e.replaceRange(v+f.string+v,y,b),b.ch+=v.length,void e.setCursor(b)}i[o]=v}else x(g.token)&&e.replaceRange("",{line:u,ch:g.token.start},{line:u,ch:g.token.end}),p.i_token!==g.i_token&&x(p.token)&&e.replaceRange("",{line:u,ch:p.token.start},{line:u,ch:p.token.end})}else{var k=e.getTokenAt(l),T=k?k.state:d,L=M(T);i[o]=L+h+L}}e.replaceSelections(i)}}function Tt(e,t){var n=ct,r=t.line,i=0,o=0,a=n.exec(e.getLine(r)),l=a[1];do{var s=r+(i+=1),d=e.getLine(s),c=n.exec(d);if(c){var h=c[1],u=parseInt(a[3],10)+i-o,f=parseInt(c[3],10),m=f;if(l!==h||isNaN(f)){if(l.length>h.length)return;if(l.length<h.length&&1===i)return;o+=1}else u===f&&(m=f+1),f<u&&(m=u+1),e.replaceRange(d.replace(n,h+m+c[4]+c[5]),{line:s,ch:0},{line:s,ch:d.length})}}while(c)}Object.assign(q.commands,{hmdNewlineAndContinue:pt,hmdNewline:gt,hmdShiftTab:yt,hmdTab:bt});q.keyMap.default;var Lt={"Shift-Tab":"hmdShiftTab",Tab:"hmdTab",Enter:"hmdNewlineAndContinue","Shift-Enter":"hmdNewline","Ctrl-B":kt(function(e){return e.strong},function(e){return/ formatting-strong /.test(e.type)},function(e){return z(e&&e.strong||"*",2)}),"Ctrl-I":kt(function(e){return e.em},function(e){return/ formatting-em /.test(e.type)},function(e){return e&&e.em||"*"}),"Ctrl-D":kt(function(e){return e.strikethrough},function(e){return/ formatting-strikethrough /.test(e.type)},function(e){return"~~"}),fallthrough:"default"};Lt=q.normalizeKeyMap(Lt),q.keyMap.hypermd=Lt,o.keyMap="hypermd";var wt=Object.freeze({newlineAndContinue:pt,newline:gt,shiftTab:yt,tab:bt,wrapTexts:function(e,t,n){var r;if(e.getOption("disableInput"))return q.Pass;var i=e.listSelections(),o=new Array(i.length),a=new Array(i.length),l=!1,s=!1,d=!1;n||(n=t);for(var c=t.length,h=n.length,u=0;u<i.length;u++){o[u]=a[u]="";var f=i[u],m=f.head,p=f.anchor,g=e.getLine(m.line);if(f.empty())m.ch>=c&&g.substr(m.ch-c,c)===t?(d=!0,m.ch-=c):(s=!0,a[u]=t);else{l=!0,0<q.cmpPos(m,p)&&(p=(r=[m,p])[0],m=r[1]);var v=e.getRange(m,p);m.ch>=c&&m.line===p.line&&g.substr(m.ch-c,c)===t&&g.substr(p.ch,h)===n&&(d=!0,p.ch+=h,m.ch-=c,v=t+v+n),v.slice(0,c)===t&&v.slice(-h)===n?o[u]=v.slice(c,-h):o[u]=t+v+n}}d&&e.setSelections(i),s&&e.replaceSelections(a),l&&e.replaceSelections(o,"around")},createStyleToggler:kt,get keyMap(){return Lt}});e.Mode=g,e.InsertFile=S,e.ReadLink=E,e.Hover=re,e.Click=ce,e.Paste=ve,e.Fold=xe,e.FoldMath=Ne,e.FoldHTML=qe,e.TableAlign=Xe,e.ModeLoader=Ze,e.HideToken=it,e.CursorDebounce=dt,e.KeyMap=wt,e.Addon=f,e.FlipFlop=s,e.tryToRun=c,e.debounce=h,e.addClass=r,e.rmClass=i,e.contains=t,e.repeat=a,e.repeatStr=z,e.visitElements=m,e.watchSize=p,e.suggestedEditorConfig=o,e.fromTextArea=function(e,t){var n=Object.assign({},o,t);return q.fromTextArea(e,n)},e.switchToNormal=function(e,t){e.setOption("theme",t||"default"),e.setOption("hmdFold",!1),e.setOption("hmdHideToken",!1),e.setOption("hmdTableAlign",!1)},e.switchToHyperMD=function(e,t){e.setOption("theme",t||"hypermd-light"),e.setOption("hmdFold",!0),e.setOption("hmdHideToken",!0),e.setOption("hmdTableAlign",!0)},e.cm_internal=n,e.TokenSeeker=U,e.getEveryCharToken=function(e){var t=new Array(e.text.length),n=e.styles,r=0;if(n)for(var i=1;i<n.length;i+=2)for(var o=n[i],a=n[i+1];r<o;)t[r++]=a;else for(var l=(e.parent.cm||e.parent.parent.cm||e.parent.parent.parent.cm).getLineTokens(e.lineNo()),s=0;s<l.length;s++)for(var d=l[s].end,c=l[s].type;r<d;)t[r++]=c;return t},e.expandRange=x,e.updateCursorDisplay=d,Object.defineProperty(e,"__esModule",{value:!0})});
